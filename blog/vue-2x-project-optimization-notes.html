<!DOCTYPE html>
<html lang="zh-cmn-Hans">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue 2.x 项目优化笔记 | 王小错</title>
    <meta name="description" content="这里是王小错，你好呀。">
    <link rel="stylesheet" href="/assets/style.019f39fc.css">
    <link rel="modulepreload" href="/assets/Home.521ab7b7.js">
    <link rel="modulepreload" href="/assets/app.a7b90192.js">
    <link rel="modulepreload" href="/assets/blog_vue-2x-project-optimization-notes.md.88060641.lean.js">
    
    <meta name="twitter:title" content="Vue 2.x 项目优化笔记 | 王小错">
  <meta property="og:title" content="Vue 2.x 项目优化笔记 | 王小错">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="王小错, back to home" data-v-675d8756 data-v-4a583abe><!----> 王小错</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/" data-v-b8818f8c>首页 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/blog/vue-2x-project-optimization-notes" data-v-b8818f8c>博文 <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/wangxiaocuo" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/" data-v-b8818f8c>首页 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/blog/vue-2x-project-optimization-notes" data-v-b8818f8c>博文 <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/wangxiaocuo" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><p class="sidebar-link-item">技术</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item active" href="/blog/vue-2x-project-optimization-notes">Vue 2.x 项目优化笔记</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#路由懒加载">路由懒加载</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#异步组件">异步组件</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#定义全局异步组件">定义全局异步组件</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#注册局部异步组件">注册局部异步组件</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#生产环境禁止输出-sourcemap">生产环境禁止输出 SourceMap</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#生产环境禁止日志打印和-debugger">生产环境禁止日志打印和 debugger</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#vue-cli-3-配置方式">Vue CLI 3 配置方式</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#vue-cli-4-配置方式">Vue CLI 4+ 配置方式</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#常用依赖的优化">常用依赖的优化</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#moment-js-2-x">Moment.js 2.x</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#lodash-4-x">Lodash 4.x</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#echarts-5-x">ECharts 5.x</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-使用官方的在线定制功能">2. 使用官方的在线定制功能</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#cdn-优化">CDN 优化</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-假设公司有-cdn-服务器">1. 假设公司有 CDN 服务器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-假设公司-it-部门很严格，屏蔽了第三方-cdn-站点">2. 假设公司 IT 部门很严格，屏蔽了第三方 CDN 站点</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_3-假设公司的服务器配置非常给力">3. 假设公司的服务器配置非常给力</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-最后来讨论可以用-cdn-优化的场景">4. 最后来讨论可以用 CDN 优化的场景</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#gzip-压缩">Gzip 压缩</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#利用-ngx-http-gzip-module-模块实时压缩">利用 ngxhttpgzip_module 模块实时压缩</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#利用-http-gzip-static-module-模块静态压缩">利用 httpgzipstatic_module 模块静态压缩</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#实时压缩和静态压缩结合使用">实时压缩和静态压缩结合使用</a><!----></li></ul></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/js-judgment-data-type">JavaScript 判断数据类型</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/accumulation-of-mobile-dev-skills">移动端开发技巧积累</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/centos-7x-install-java-1-8">CentOS 7.x 安装 Java 1.8</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/centos-7x-install-node-error-by-gcc">CentOS 7.x 安装 Node.js 时报错 g++ fatal error</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/centos-7x-update-gcc">CentOS 7.x 升级 gcc 版本</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-cli-3x-global-style-variable-config">Vue CLI 3+ 中配置全局样式变量</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/simplify-front-end-release-with-shell">用 shell 脚本简化前端项目发版链路</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vue-2x-render-function-and-jsx">vue2.x 之渲染函数 &amp; JXS</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/macos-install-nginx-1-18-0">MacOS 安装 nginx-1.18.0</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/date-format-in-front-end">聊聊前端开发中的日期格式</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/pscc-light-speed-cut-graph">使用 PhotoShop CC 资源生成器“光速”切图</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/macos-front-end-config-and-tool-install">MacOS 前端向配置和工具安装</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/problems-caused-by-line-breaks">跨平台开发时换行符带来的问题</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vscode-code-snippet-config">VSCode 代码片段配置</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/vscode-plugins-and-config-file">VSCode 插件和配置文件</a><!----></li></ul></li><li class="sidebar-link"><p class="sidebar-link-item">随笔</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/simple-longing">简单的向往</a><!----></li></ul></li><li class="sidebar-link"><p class="sidebar-link-item">游戏</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/blog/macos-install-stardew-valley-mods">MacOS 安装「星露谷物语」模组</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="vue-2-x-项目优化笔记" tabindex="-1">Vue 2.x 项目优化笔记 <a class="header-anchor" href="#vue-2-x-项目优化笔记" aria-hidden="true">#</a></h1><blockquote><p>以下 Vue CLI 的相关配置是在 Vue CLI 版本 &gt;= 3.0 的基础上</p></blockquote><h1 id="包内容分析" tabindex="-1">包内容分析 <a class="header-anchor" href="#包内容分析" aria-hidden="true">#</a></h1><p>Vue CLI 集成了 <a href="https://github.com/webpack-contrib/webpack-bundle-analyzer" target="_blank" rel="noopener noreferrer"><code>webpack-bundle-size-analyzer</code></a> 插件，打包命令提供了 <code>--report</code> 和 <code>--report-json</code> 两种命令参数来帮助我们分析包中包含的模块们的大小。</p><ul><li><code>--report</code>：生成 report.html 以帮助分析包内容</li><li><code>--report-json</code>：生成 report.json 以帮助分析包内容</li></ul><p>所以我们可以自定义一个 <code>npm script</code>，在 <code>package.json</code> 中的 <code>scripts</code> 属性值中追加：</p><div class="language-json"><pre><code><span class="token property">&quot;build:report&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue-cli-service build --report --report-json&quot;</span><span class="token punctuation">,</span>
</code></pre></div><p>想生成带有分析报告的打包文件时，敲 <code>npm run build:report</code></p><p><code>report.html</code> 打开后显示如下：</p><p><img src="https://wxc-open-space.oss-cn-shanghai.aliyuncs.com/vue-2x-project-optimization-notes/5dcfa93c-27c6-4c2a-bcf0-bb9af07bade1.gif" alt="1"></p><h1 id="优化措施" tabindex="-1">优化措施 <a class="header-anchor" href="#优化措施" aria-hidden="true">#</a></h1><h2 id="路由懒加载" tabindex="-1">路由懒加载 <a class="header-anchor" href="#路由懒加载" aria-hidden="true">#</a></h2><p><a href="https://router.vuejs.org/zh/guide/advanced/lazy-loading.html#%E8%B7%AF%E7%94%B1%E6%87%92%E5%8A%A0%E8%BD%BD" target="_blank" rel="noopener noreferrer">Vue Router 官网介绍</a></p><p>原理是把不同路由对应的组件分割成不同的代码块，然后当路由被访问的时候才加载对应组件，提升加载速度。</p><p>使用示例：</p><div class="language-js"><pre><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  routes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">&#39;/foo&#39;</span><span class="token punctuation">,</span> <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;./Foo.vue&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// or</span>

<span class="token keyword">const</span> <span class="token function-variable function">Foo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;./Foo.vue&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  routes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">&#39;/foo&#39;</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Foo <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="异步组件" tabindex="-1">异步组件 <a class="header-anchor" href="#异步组件" aria-hidden="true">#</a></h2><p><a href="https://cn.vuejs.org/v2/guide/components-dynamic-async.html#%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6" target="_blank" rel="noopener noreferrer">Vue 官网介绍</a></p><p>在大型应用中，我们可能需要将应用分割成小一些的代码块，并且只在需要的时候才从服务器加载一个模块。异步组件契合按需加载的需求。</p><h3 id="定义全局异步组件" tabindex="-1">定义全局异步组件 <a class="header-anchor" href="#定义全局异步组件" aria-hidden="true">#</a></h3><div class="language-js"><pre><code>Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">&#39;async-webpack-example&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这个特殊的 `require` 语法将会告诉 webpack</span>
  <span class="token comment">// 自动将你的构建代码切割成多个包，这些包</span>
  <span class="token comment">// 会通过 Ajax 请求加载</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;./my-async-component&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// or</span>

Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span>
  <span class="token string">&#39;async-webpack-example&#39;</span><span class="token punctuation">,</span>
  <span class="token comment">// 这个动态导入会返回一个 `Promise` 对象。</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;./my-async-component&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="注册局部异步组件" tabindex="-1">注册局部异步组件 <a class="header-anchor" href="#注册局部异步组件" aria-hidden="true">#</a></h3><div class="language-js"><pre><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&#39;my-component&#39;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;./my-async-component&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="生产环境禁止输出-sourcemap" tabindex="-1">生产环境禁止输出 SourceMap <a class="header-anchor" href="#生产环境禁止输出-sourcemap" aria-hidden="true">#</a></h2><p><code>SourceMap</code> 文件可以使浏览器能够像调试源代码一样调试被混淆压缩后的 <code>JavaScript</code> 代码，所以在非生产环境，<code>SourceMap</code> 对于调试是有利的。</p><p>但是 <code>SourceMap</code> 文件有一定的安全隐患，有心人士可以通过 <code>SourceMap</code> 文件中的映射，更容易地还原出前端完整代码。</p><p>所以生产环境应该禁止输出 <code>SourceMap</code>，这样既可以加速生产环境的构建，又可以规避一部分信息安全问题。</p><p>Vue CLI 的 <code>productionSourceMap</code> 配置可以控制生产环境不输出 <code>SourceMap</code> 文件：</p><div class="language-js"><pre><code><span class="token comment">// vue.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果你不需要生产环境的 source map</span>
  productionSourceMap<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="生产环境禁止日志打印和-debugger" tabindex="-1">生产环境禁止日志打印和 debugger <a class="header-anchor" href="#生产环境禁止日志打印和-debugger" aria-hidden="true">#</a></h2><p>Vue CLI 内置了 <code>terser-webpack-plugin</code> 插件，使用它可以控制是否移除日志打印和 <code>debugger</code>。</p><h3 id="vue-cli-3-配置方式" tabindex="-1">Vue CLI 3 配置方式 <a class="header-anchor" href="#vue-cli-3-配置方式" aria-hidden="true">#</a></h3><div class="language-js"><pre><code><span class="token comment">// vue.config.js</span>

<span class="token keyword">const</span> TerserPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;terser-webpack-plugin&#39;</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">chainWebpack</span><span class="token operator">:</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config<span class="token punctuation">.</span>optimization<span class="token punctuation">.</span><span class="token function">minimizer</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          terserOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
            compress<span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token comment">// 移除所有的日志打印</span>
              <span class="token comment">// drop_console: true,</span>
              <span class="token comment">// 移除所有的 debugger</span>
              drop_debugger<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token comment">// 该配置可以只移除一部分 log，但是必须设置 drop_console 为 false，如果值为 [&#39;console.*&#39;] 也是移除所有</span>
              pure_funcs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;console.log&#39;</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="vue-cli-4-配置方式" tabindex="-1">Vue CLI 4+ 配置方式 <a class="header-anchor" href="#vue-cli-4-配置方式" aria-hidden="true">#</a></h3><div class="language-js"><pre><code><span class="token comment">// vue.config.js</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">chainWebpack</span><span class="token operator">:</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span><span class="token punctuation">,</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      config<span class="token punctuation">.</span>optimization<span class="token punctuation">.</span><span class="token function">minimizer</span><span class="token punctuation">(</span><span class="token string">&#39;terser&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">args</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 移除所有的日志打印</span>
        <span class="token comment">// args[0].terserOptions.compress[&quot;drop_console&quot;] = true;</span>
        <span class="token comment">// 移除所有的 debugger</span>
        args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>terserOptions<span class="token punctuation">.</span>compress<span class="token punctuation">[</span><span class="token string">&#39;drop_debugger&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
        args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>terserOptions<span class="token punctuation">.</span>compress<span class="token punctuation">[</span><span class="token string">&#39;pure_funcs&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;console.log&#39;</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> args
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="常用依赖的优化" tabindex="-1">常用依赖的优化 <a class="header-anchor" href="#常用依赖的优化" aria-hidden="true">#</a></h2><blockquote><p>以下优化针对于没有使用 CDN 的依赖，如果以下依赖已经托管给了 CDN，可以忽略。</p></blockquote><h3 id="moment-js-2-x" tabindex="-1">Moment.js 2.x <a class="header-anchor" href="#moment-js-2-x" aria-hidden="true">#</a></h3><p><a href="https://momentjs.com/" target="_blank" rel="noopener noreferrer"><code>Moment.js</code></a> 是老牌的日期处理工具，正因为老牌，所以不能按需引入，其次通过分析图可见，打包后的 <code>Moment.js</code> 除了主包外，还有大量的语言包，占用体积比较大。</p><p><img src="https://wxc-open-space.oss-cn-shanghai.aliyuncs.com/vue-2x-project-optimization-notes/9cbe2721-4d8f-4dea-b318-e311df8df939.jpg" alt="2"></p><p>优化方案有两种：</p><ul><li>弃用 <code>Moment.js</code>，使用可以按需加载的 <a href="https://dayjs.gitee.io/zh-CN/" target="_blank" rel="noopener noreferrer"><code>Day.js</code></a> 或 <a href="https://date-fns.org/" target="_blank" rel="noopener noreferrer"><code>date-fns</code></a></li><li>去除冗余的语言包</li></ul><p>第一种方案简单直接，<code>Day.js</code> 和 <code>date-fns</code> 使用就不展开细讲了，感兴趣的可以移步官网。</p><p>下面讲讲第二种。</p><p>参考 <a href="https://github.com/jmblog/how-to-optimize-momentjs-with-webpack" target="_blank" rel="noopener noreferrer">《How to optimize moment.js with webpack》</a>，可以使用 <code>webpack.IgnorePlugin()</code> 忽略 <code>Moment.js</code> 语言包，手动引入的语言包会被打包进 <code>chunk-vendors</code> 中。</p><div class="language-js"><pre><code><span class="token comment">// vue.config.js</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack&#39;</span><span class="token punctuation">)</span>

configureWebpack<span class="token operator">:</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>IgnorePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      resourceRegExp<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\.\/locale$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      contextRegExp<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">moment$</span><span class="token regex-delimiter">/</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">//</span>
<span class="token function-variable function">chainWebpack</span><span class="token operator">:</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  config
    <span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&#39;ignore&#39;</span><span class="token punctuation">)</span>
    <span class="token comment">// 忽略 moment/locale 下的所有文件，优化 moment 的体积</span>
    <span class="token comment">// https://github.com/jmblog/how-to-optimize-momentjs-with-webpack</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>IgnorePlugin</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\.\/locale$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">moment$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>假设我们只引入了简体中文包，效果如下：</p><div class="language-js"><pre><code><span class="token keyword">import</span> moment <span class="token keyword">from</span> <span class="token string">&#39;moment&#39;</span>
<span class="token keyword">import</span> <span class="token string">&#39;moment/locale/zh-cn&#39;</span>

moment<span class="token punctuation">.</span><span class="token function">locale</span><span class="token punctuation">(</span><span class="token string">&#39;zh-cn&#39;</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;现在时间：&#39;</span><span class="token punctuation">,</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&#39;MMMM&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 现在时间： 八月</span>
</code></pre></div><p><img src="https://wxc-open-space.oss-cn-shanghai.aliyuncs.com/vue-2x-project-optimization-notes/d515cb1b-4a57-43ef-9e92-c0cc6cab2211.jpg" alt="3"></p><p><img src="https://wxc-open-space.oss-cn-shanghai.aliyuncs.com/vue-2x-project-optimization-notes/0094d338-ead0-4038-9ed3-57cf63ab3e58.jpg" alt="4"></p><h3 id="lodash-4-x" tabindex="-1">Lodash 4.x <a class="header-anchor" href="#lodash-4-x" aria-hidden="true">#</a></h3><p>很多文章对于 <code>Lodash</code> 的优化，都是使用 <code>lodash-webpack-plugin</code> 这个插件，但是实际使用下来会有很多的问题，详情请见黑猫的<a href="https://zhuanlan.zhihu.com/p/349260482" target="_blank" rel="noopener noreferrer">《为什么你应该立即停止使用 lodash-webpack-plugin》</a>。</p><p>并且在不出错的情况下 <code>lodash-webpack-plugin</code> 这个插件的效果与 <code>import { head } from &#39;lodash-es&#39;</code> 和 <code>import head from &#39;lodash/head&#39;</code> 的效果几乎一致，它只是针对于 <code>import { head } from &#39;lodash&#39;</code> 这种形式的引入做了优化处理。</p><div class="language-js"><pre><code><span class="token comment">// 整个 lodash 都会被打包，压缩后 72K</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> head <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;lodash&#39;</span>
<span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 打包压缩后 1K</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> head <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;lodash-es&#39;</span>
<span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 打包压缩后 1K</span>
<span class="token keyword">import</span> head <span class="token keyword">from</span> <span class="token string">&#39;lodash/head&#39;</span>
<span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>得益于 ES6+ 的各种黑科技，其实在大多数情况下，我们对于 <code>Lodash</code> 和 <code>Underscore</code> 等工具函数库的需求并不大，很多方法都有替代方案。详情请见 <a href="https://github.com/you-dont-need/You-Dont-Need-Lodash-Underscore" target="_blank" rel="noopener noreferrer">《You don&#39;t (may not) need Lodash/Underscore》</a>。</p><p>所以我对于 <code>Lodash</code> 的优化建议是：</p><ul><li>如果需求不大就弃用；</li><li>如果需求真的很大，就使用 <code>lodash-es</code> 或手动按需引入。</li><li>或者等待模块化的 <code>Lodash</code> 现世</li></ul><h3 id="echarts-5-x" tabindex="-1">ECharts 5.x <a class="header-anchor" href="#echarts-5-x" aria-hidden="true">#</a></h3><p>ECharts 的图表非常丰富，这也导致了它的全量包体积很大，如果全量引入：</p><p><img src="https://wxc-open-space.oss-cn-shanghai.aliyuncs.com/vue-2x-project-optimization-notes/0596b46a-588f-489f-90a0-b55874cad2a3.jpg" alt="echarts-all"></p><p>有两种方式可以做到按需引入</p><h4 id="_1-按需引入-echarts-图表和组件" tabindex="-1">1. 按需引入 ECharts 图表和组件 <a class="header-anchor" href="#_1-按需引入-echarts-图表和组件" aria-hidden="true">#</a></h4><p>从 5.x 开始，官方提供了<a href="https://echarts.apache.org/zh/tutorial.html#%E5%9C%A8%E6%89%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%AD%E4%BD%BF%E7%94%A8%20ECharts" target="_blank" rel="noopener noreferrer">新的按需引入方式</a></p><div class="language-js"><pre><code><span class="token comment">// 引入 echarts 核心模块，核心模块提供了 echarts 使用必须要的接口。</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> echarts <span class="token keyword">from</span> <span class="token string">&#39;echarts/core&#39;</span>
<span class="token comment">// 引入柱状图图表，图表后缀都为 Chart</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BarChart <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;echarts/charts&#39;</span>
<span class="token comment">// 引入提示框，标题，直角坐标系组件，组件后缀都为 Component</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  TitleComponent<span class="token punctuation">,</span>
  TooltipComponent<span class="token punctuation">,</span>
  GridComponent
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;echarts/components&#39;</span>
<span class="token comment">// 引入 Canvas 渲染器，注意引入 CanvasRenderer 或者 SVGRenderer 是必须的一步</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CanvasRenderer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;echarts/renderers&#39;</span>

<span class="token comment">// 注册必须的组件</span>
echarts<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  TitleComponent<span class="token punctuation">,</span>
  TooltipComponent<span class="token punctuation">,</span>
  GridComponent<span class="token punctuation">,</span>
  BarChart<span class="token punctuation">,</span>
  CanvasRenderer
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>可以选择把 <code>echarts</code> 注册在 Vue 原型上</p><div class="language-js"><pre><code><span class="token comment">// main.js</span>

<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$echarts <span class="token operator">=</span> echarts
</code></pre></div><p>来看一下效果：</p><p><img src="https://wxc-open-space.oss-cn-shanghai.aliyuncs.com/vue-2x-project-optimization-notes/78a9e666-d614-45ee-9aef-de5b61cf50fc.jpg" alt="echarts-compress"></p><h3 id="_2-使用官方的在线定制功能" tabindex="-1">2. 使用官方的在线定制功能 <a class="header-anchor" href="#_2-使用官方的在线定制功能" aria-hidden="true">#</a></h3><p>如果你觉得按需引入的方式心智负担很重，也可以选择使用官方的<a href="https://echarts.apache.org/zh/builder.html" target="_blank" rel="noopener noreferrer">在线定制功能</a>按需生成 <code>echarts.min.js</code> 文件。</p><p><img src="https://wxc-open-space.oss-cn-shanghai.aliyuncs.com/vue-2x-project-optimization-notes/dcaae3a2-3ee4-4b7c-bb45-dbc63223326f.jpg" alt="echarts-compress"></p><h2 id="cdn-优化" tabindex="-1">CDN 优化 <a class="header-anchor" href="#cdn-优化" aria-hidden="true">#</a></h2><blockquote><p>不要盲目的把所有依赖都更换成第三方 CDN 方式引入，我觉得这个优化点需要分情况讨论。</p></blockquote><h3 id="_1-假设公司有-cdn-服务器" tabindex="-1">1. 假设公司有 CDN 服务器 <a class="header-anchor" href="#_1-假设公司有-cdn-服务器" aria-hidden="true">#</a></h3><p>第三方的 CDN 其实不一定可信，起码不可能一直可信，假设公司有自己的 CDN 服务器，那就最好了。</p><p>这时候除了 <code>index.html</code> 的所有静态资源（包括 <code>js</code>、<code>css</code>、<code>图片</code>、<code>视频</code>、<code>字体</code>等）都可以部署到 CDN 服务器上，这样本地的静态资源和依赖该怎么引入还怎么引入，完全不需要变动，只需要打包的时候 Vue CLI 的 <code>assetsDir</code> 配置为 CDN 对应路径。</p><p>至于为什么不连 <code>index.html</code> 也一起放在 CDN，如果这个网站是公司内部使用，可以放；如果是对外的站点，一是让用户用 CDN 路径去访问站点不太合适，二是 <code>index.html</code> 放在域名对应的服务器可以更方便的做网关层面的操作，比如 IP 限流、反向代理等。</p><div class="language-js"><pre><code><span class="token comment">// vue.config.js</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  assetsDir<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span> <span class="token operator">?</span> <span class="token string">&#39;path/to/your/CDN&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;&#39;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-假设公司-it-部门很严格，屏蔽了第三方-cdn-站点" tabindex="-1">2. 假设公司 IT 部门很严格，屏蔽了第三方 CDN 站点 <a class="header-anchor" href="#_2-假设公司-it-部门很严格，屏蔽了第三方-cdn-站点" aria-hidden="true">#</a></h3><p>大公司的 IT 部门监管一般很严格，这时候就不要考虑使用第三方 CDN 了，我就遇到过本来能正常使用的 CDN，过段时间发现被 IT 部门屏蔽了。再说大型企业一般都有自己的 CDN 服务器。</p><h3 id="_3-假设公司的服务器配置非常给力" tabindex="-1">3. 假设公司的服务器配置非常给力 <a class="header-anchor" href="#_3-假设公司的服务器配置非常给力" aria-hidden="true">#</a></h3><p>可以不用考虑使用第三方 CDN。</p><h3 id="_4-最后来讨论可以用-cdn-优化的场景" tabindex="-1">4. 最后来讨论可以用 CDN 优化的场景 <a class="header-anchor" href="#_4-最后来讨论可以用-cdn-优化的场景" aria-hidden="true">#</a></h3><p>上面三种情况只是举例，具体是否使用 CDN，要综合评估加载速度和总包流量，还请自行考量。</p><p>哪些依赖可以使用 CDN 呢？我的思路是针对那些必须全量引入的依赖，比如 <code>Vue</code>、<code>Vue Router</code>、<code>Vuex</code>、<code>Axios</code>、<code>NProgress</code>、<code>JQuery</code> 等。</p><p>像 <code>Element</code>、<code>Antd Vue</code> 这些 UI 框架，我选择不使用 CDN，因为它们本身可以按需引入，并且如果使用 CDN，改变主题颜色等操作就会变得复杂。当然如果你觉得使用 CDN 带来的加载速度提升大大优于不使用 CDN，并且没有动态改变主题等需求，那当然可以走 CDN。</p><p>其次要考虑，开发环境要和生产环境得区分开来，开发环境还是要使用本地的依赖，不然没有代码提示太痛苦了，效率也会降低。</p><p>另外 Vue CLI 帮我们集成了 <a href="https://github.com/jantimon/html-webpack-plugin#options" target="_blank" rel="noopener noreferrer">html-webpack-plugin</a> 插件，我们可以基于该插件，只在生产环境使用 CDN。</p><p><code>vue.config.js</code> 修改如下：</p><div class="language-js"><pre><code><span class="token comment">// vue.config.js</span>

<span class="token keyword">const</span> <span class="token constant">CDN_CONFIGS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  externals<span class="token operator">:</span> <span class="token punctuation">{</span>
    vue<span class="token operator">:</span> <span class="token string">&#39;Vue&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;vue-router&#39;</span><span class="token operator">:</span> <span class="token string">&#39;VueRouter&#39;</span><span class="token punctuation">,</span>
    vuex<span class="token operator">:</span> <span class="token string">&#39;Vuex&#39;</span><span class="token punctuation">,</span>
    axios<span class="token operator">:</span> <span class="token string">&#39;axios&#39;</span><span class="token punctuation">,</span>
    nprogress<span class="token operator">:</span> <span class="token string">&#39;NProgress&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  links<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&#39;https://cdn.bootcdn.net/ajax/libs/nprogress/0.2.0/nprogress.min.css&#39;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  scripts<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&#39;https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.min.js&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;https://cdn.bootcdn.net/ajax/libs/vue-router/3.2.0/vue-router.min.js&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;https://cdn.bootcdn.net/ajax/libs/vuex/3.5.1/vuex.min.js&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;https://cdn.bootcdn.net/ajax/libs/axios/0.21.0/axios.min.js&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;https://cdn.bootcdn.net/ajax/libs/nprogress/0.2.0/nprogress.min.js&#39;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">chainWebpack</span><span class="token operator">:</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span><span class="token punctuation">,</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      config<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;externals&#39;</span><span class="token punctuation">,</span> <span class="token constant">CDN_CONFIGS</span><span class="token punctuation">.</span>externals<span class="token punctuation">)</span>

      config<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&#39;html&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">args</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token constant">USE_CDN</span> <span class="token operator">=</span> <span class="token boolean">true</span>
        args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>links <span class="token operator">=</span> <span class="token constant">CDN_CONFIGS</span><span class="token punctuation">.</span>links
        args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>scripts <span class="token operator">=</span> <span class="token constant">CDN_CONFIGS</span><span class="token punctuation">.</span>scripts
        <span class="token keyword">return</span> args
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>index.html</code> 中使用 <a href="https://ejs.bootcss.com/#promo" target="_blank" rel="noopener noreferrer">EJS</a> 的语法引入样式和脚本，如下：</p><div class="language-html"><pre><code><span class="token comment">&lt;!-- index.html --&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>zh-cmn-Hans<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 其他代码... --&gt;</span>

    <span class="token comment">&lt;!-- CDN 引入CSS --&gt;</span>
    &lt;% if (htmlWebpackPlugin.options.USE_CDN) { %&gt; &lt;%
    htmlWebpackPlugin.options.links.forEach(function (link) { %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>&lt;%= link %&gt;<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    &lt;% }) %&gt; &lt;% } %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 其他代码... --&gt;</span>

    <span class="token comment">&lt;!-- CDN 引入JS --&gt;</span>
    &lt;% if (htmlWebpackPlugin.options.USE_CDN) { %&gt; &lt;%
    htmlWebpackPlugin.options.scripts.forEach(function (script) { %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>&lt;%= script %&gt;<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    &lt;% }) %&gt; &lt;% } %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>打包之后的 <code>index.html</code> 代码如下：</p><p><img src="https://wxc-open-space.oss-cn-shanghai.aliyuncs.com/vue-2x-project-optimization-notes/e22e3422-d169-42c5-8c11-d55eb759d6a4.png" alt="5"></p><blockquote><p>webpack 的 <a href="https://webpack.js.org/configuration/externals/#externals" target="_blank" rel="noopener noreferrer">外部扩展 Externals</a>，让程序可以在运行时再去从外部获取扩展依赖。所以在使用 CDN 时，只要是定义好的外部扩展，项目中 <code>import xxx from ‘xxx’</code> 的引入方式依然可以正常运行，不需要做任何改动。</p></blockquote><h2 id="gzip-压缩" tabindex="-1">Gzip 压缩 <a class="header-anchor" href="#gzip-压缩" aria-hidden="true">#</a></h2><p>Gzip 是一种用于文件压缩与解压缩的文件格式。以 Nginx 为例，有两种方式开启 Gzip。</p><h3 id="利用-ngx-http-gzip-module-模块实时压缩" tabindex="-1">利用 ngx_http_gzip_module 模块实时压缩 <a class="header-anchor" href="#利用-ngx-http-gzip-module-模块实时压缩" aria-hidden="true">#</a></h3><p>通过 <code>ngx_http_gzip_module</code> 模块拦截请求，并对需要做 Gzip 的资源进行实时压缩，会消耗 CPU 资源。</p><p><code>ngx_http_gzip_module</code> 模块是 Nginx 默认集成的，不需要额外编译安装。</p><p>配置示例：</p><div class="language-shell"><pre><code><span class="token comment"># 开启 Gzip</span>
<span class="token function">gzip</span> on<span class="token punctuation">;</span>

<span class="token comment"># 设置允许压缩的文件最小字节数</span>
gzip_min_length 1k<span class="token punctuation">;</span>

<span class="token comment"># 设置压缩级别，取值 1-9，数字越大压缩的越好，也更消耗 CPU 的资源和时间</span>
gzip_comp_level <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment"># 设置允许进行压缩的文件类型。JavaScript 有多种形式。其中的值可以在 mime.types 文件中找到。</span>
gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/svg+xml<span class="token punctuation">;</span>

<span class="token comment"># 是否在 HTTP header 中添加 Vary: Accept-Encoding，建议开启</span>
gzip_vary on<span class="token punctuation">;</span>

<span class="token comment"># IE 6 及以下 禁用</span>
gzip_disable <span class="token string">&quot;MSIE [1-6]\.&quot;</span><span class="token punctuation">;</span>

<span class="token comment"># 设置压缩所需要的缓冲区大小</span>
gzip_buffers <span class="token number">4</span> 16k<span class="token punctuation">;</span>

<span class="token comment"># 设置压缩针对的 HTTP 协议版本</span>
gzip_http_version <span class="token number">1.0</span> <span class="token operator">|</span> <span class="token number">1.1</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="利用-http-gzip-static-module-模块静态压缩" tabindex="-1">利用 http_gzip_static_module 模块静态压缩 <a class="header-anchor" href="#利用-http-gzip-static-module-模块静态压缩" aria-hidden="true">#</a></h3><p><code>http_gzip_static_module</code> 模块不消耗 CPU 资源，该模块需要额外安装。</p><p>开启很简单：</p><div class="language-shell"><pre><code>gzip_static  on<span class="token punctuation">;</span>
</code></pre></div><p><code>http_gzip_static_module</code> 模块需要我们实现准备好压缩好的资源。前端需要利用到 <code>compression-webpack-plugin</code> 这个 webpack 插件，在打包的时候同时生成 <code>.gz</code> 格式的文件。</p><ol><li>安装 <code>compression-webpack-plugin</code></li></ol><p>不要安装版本 7.x 或者 8.x，会报以下错误：</p><div class="language-shell"><pre><code>TypeError: Cannot <span class="token builtin class-name">read</span> property <span class="token string">&#39;tapPromise&#39;</span> of undefined
</code></pre></div><p>只能安装低版本的 6.x 或 5.x：</p><div class="language-shell"><pre><code><span class="token function">npm</span> i -D compression-webpack-plugin@6.x
<span class="token comment"># or</span>
<span class="token function">yarn</span> <span class="token function">add</span> -D compression-webpack-plugin@6.1.1
</code></pre></div><ol start="2"><li>vue.config.js 配置：</li></ol><div class="language-js"><pre><code><span class="token comment">// vue.config.js</span>

<span class="token keyword">const</span> CompressionWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;compression-webpack-plugin&#39;</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">chainWebpack</span><span class="token operator">:</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span><span class="token punctuation">,</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      config<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&#39;compression&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">CompressionWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          filename<span class="token operator">:</span> <span class="token string">&#39;[path][base].gz&#39;</span><span class="token punctuation">,</span>
          algorithm<span class="token operator">:</span> <span class="token string">&#39;gzip&#39;</span><span class="token punctuation">,</span>
          test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$|\.css$|\.html$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
          <span class="token comment">// 仅处理大于此大小的资源（以字节为单位），</span>
          threshold<span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>
          minRatio<span class="token operator">:</span> <span class="token number">0.8</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>压缩效果如下，所有大于 <code>1kb</code> 的资源都生成了同名的 <code>.gz</code> 文件：</p><p><img src="https://wxc-open-space.oss-cn-shanghai.aliyuncs.com/vue-2x-project-optimization-notes/2c3867fe-b9ff-4b12-a1dc-5e85e351b7ee.jpg" alt="1"></p><h3 id="实时压缩和静态压缩结合使用" tabindex="-1">实时压缩和静态压缩结合使用 <a class="header-anchor" href="#实时压缩和静态压缩结合使用" aria-hidden="true">#</a></h3><p>实时压缩和静态压缩可以结合使用，效果更佳。Nginx 会首先尝试使用静态压缩，如果有则直接返回 <code>.gz</code> 的预压缩文件，否则尝试动态压缩。</p><div class="language-shell"><pre><code>gzip_static       on<span class="token punctuation">;</span>

<span class="token function">gzip</span>              on<span class="token punctuation">;</span>
gzip_min_length   1k<span class="token punctuation">;</span>
gzip_comp_level   <span class="token number">1</span><span class="token punctuation">;</span>
gzip_types        text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/svg+xml<span class="token punctuation">;</span>
gzip_vary         on<span class="token punctuation">;</span>
gzip_disable      <span class="token string">&quot;MSIE [1-6]\.&quot;</span><span class="token punctuation">;</span>
gzip_buffers      <span class="token number">4</span> 16k<span class="token punctuation">;</span>
gzip_http_version <span class="token number">1.0</span> <span class="token operator">|</span> <span class="token number">1.1</span><span class="token punctuation">;</span>
</code></pre></div></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><!----></div></div><div class="updated" data-v-fb8d84c6><p class="last-updated" data-v-fb8d84c6 data-v-5797b537><span class="prefix" data-v-5797b537>最后更新时间:</span><span class="datetime" data-v-5797b537></span></p></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><!----></div><div class="next" data-v-38ede35f><a class="link" href="/blog/js-judgment-data-type" data-v-38ede35f><span class="text" data-v-38ede35f>JavaScript 判断数据类型</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"blog_accumulation-of-mobile-dev-skills.md\":\"bbac3d46\",\"blog_centos-7x-install-java-1-8.md\":\"b3140d54\",\"blog_centos-7x-install-node-error-by-gcc.md\":\"caaacbbe\",\"blog_centos-7x-update-gcc.md\":\"af010b38\",\"blog_date-format-in-front-end.md\":\"9f458ebe\",\"blog_js-judgment-data-type.md\":\"a4eab6b4\",\"blog_macos-front-end-config-and-tool-install.md\":\"b8c11cc1\",\"blog_macos-install-nginx-1-18-0.md\":\"cdb21f5d\",\"blog_macos-install-stardew-valley-mods.md\":\"e194cef7\",\"blog_problems-caused-by-line-breaks.md\":\"7a84597e\",\"blog_pscc-light-speed-cut-graph.md\":\"36b20542\",\"blog_simple-longing.md\":\"7cec1e58\",\"blog_simplify-front-end-release-with-shell.md\":\"b65e499f\",\"blog_vscode-code-snippet-config.md\":\"ad284e3f\",\"blog_vscode-plugins-and-config-file.md\":\"91c29100\",\"blog_vue-2x-project-optimization-notes.md\":\"88060641\",\"blog_vue-2x-render-function-and-jsx.md\":\"fc38fc52\",\"blog_vue-cli-3x-global-style-variable-config.md\":\"db2c702c\",\"index.md\":\"16bd196a\"}")</script>
    <script type="module" async src="/assets/app.a7b90192.js"></script>
    
  </body>
</html>